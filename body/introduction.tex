% !Mode:: "TeX:UTF-8"

\chapter{绪论}[Introduction]

\section{课题来源及研究的目的和意义}

指令集架构（ISA），是计算机的一种抽象模型，是计算机体系结构模型中与程序设计相关的部分。通常，指令集架构定义了一系列支持的数据类型、寄存器、内存管理、基本特性与IO模型。计算机处理器的指令集架构有以下常见的两种：复杂指令集架构（CISC）、精简指令集架构（RISC），前者的代表就是x86架构，而后者的代表就是ARM架构。无论如何划分，不可否认的是，当今最流行的几个指令集架构，如x86和ARM，都是商业闭源的，在使用这些指令集架构时，需要向Intel或ARM控股缴纳高额的许可费。但是，Krste Asanović等人提出了这样一个观点：指令集架构应当是开放的，并以RISC-V作为开源指令集架构的典型进行论述。

RISC-V是一个基于精简指令集原则的开源指令集架构，该项目2010年始于加州大学伯克利分校，但是该项目的贡献者更多的是校外的志愿者和行业工作者。尽管不是第一个开源指令集，但是由于RISC-V适用于各种设备，譬如云计算机、PC机、移动设备和嵌入式系统，且其开源免费的特性使得它的社区十分活跃。于是RISC-V架构一经出现，就有许多芯片设计者以此为架构设计SoC。

相较于以功耗低著称的ARM架构处理器，RISC-V性能更强、面积更小、功耗更低，且相对于ARM，指令更加丰富，可扩展性更强，并且开源免费。或许是感受到了来自RISC-V的巨大压力，ARM控股甚至上线了一个网站来专门质疑RISC-V指令集。而相对于Intel的x86指令集架构，RISC-V没有那么多的历史包袱，不需要考虑向后兼容问题，可以说是“轻装上阵”，在设计操作系统时就无须考虑类似“A20地址线”的问题。而在关键技术被其他国家卡脖子的当今中国，开源免费的RISC-V可能有助于我国打破芯片壁垒。

同时，随着我国逐渐重视核心技术国有化，保障我国核心产业自主可控，我国开始大力发展自研芯片和自研操作系统。然而，相关工作大都是在企业和研究院层面展开，并没有下沉到高校层面的，形成了产学断层。这使得对于RISC-V相关技术的研究和教学，如RISC-V架构的芯片和支持RISC-V的操作系统的相关方向，成为国内高校研学的一片空白地带。

目前，大部分高校的操作系统的课程，都是基于x86架构设计的。然而，x86架构向后兼容的特性，使得即使是较新的x86操作系统，也不得不兼容一些过时的、已经被废弃不用的特性，例如上文提到的A20地址线。这使得学生对于操作系统本身的概念，会和x86一些特性混淆。令学生可能会更专注于繁琐而多余的x86特性，而不是聚焦于操作系统领域的通用概念。而RISC-V架构的操作系统，由于架构本身的精巧轻盈，更能让学生着眼于系统自身的设计。

基于以上原因，本文讨论了一种基于C语言和RISC-V架构的操作系统的设计方案，并给出其实现代码，旨在推动RISC-V向高校课程和实验室的下沉，以期能够反哺开源社区，最终客观上促进开源社区发展，推动RISC-V在国内的传播。

\section{国内外研究现状及分析}

自2010年加州大学伯克利分校提出了RISC-V指令集架构后，官方一直聚焦于相关规范的演进，并移植了一整套GNU交叉编译工具链，以支持开源社区的开发，同时还开源了一套官方的SBI实现——OpenSBI，类似于BIOS，使得操作系统开发者们可以跳过Bootloader的开发，更专注于系统功能。

操作系统方面，除去Linux官方移植的RISC-V架构的Linux内核之外，国外比较著名的RISC-V指令集架构的通用操作系统项目主要有两个：一个是麻省理工学院的xv6-riscv项目，该项目基于C语言。xv6是该校6.828操作系统课程中使用的一个示例操作系统，原先为x86架构，2014年MIT开始着手将其迁移至RISC-V平台，并在2019年正式启用RISC-V版本作为本科教学案例。另一个比较著名的项目就是Stephen Marz的BlogOS，该项目来自于他在2019年写下的一系列教学博客，该博客的主要内容是使用Rust语言完成一个简单的RISC-V架构的操作系统内核，该项目在国外反响巨大，并催生了一些列RISC-V操作系统的Rust语言实现。

国内方面对于这方面的研究比较少，基本只有清华大学的教学用操作系统rCore。清华大学曾经使用x86架构的uCore操作系统进行课程实验。2020年开始增加基于Rust语言、RISC-V架构的rCore可以课程实验的可选项。

上面提到的三种操作系统实现的横向对比见表\ref{tab:os-compare}。

\begin{table}[h]
	\centering
	\setlength{\belowcaptionskip}{2pt}
	\caption{几种RISC-V架构操作系统的横向比较}
	\label{tab:os-compare}
	\begin{tabular}{|c|c|c|c|}
		\hline
		& xv6-riscv & BlogOS & rCore   \\ \hline
		开发语言       & C语言       & Rust语言 & Rust语言  \\ \hline
		多核支持       & 支持        & 不支持    & 支持      \\ \hline
		代码量级       & 9064      & 1276   & 3244    \\ \hline
		Bootloader & 自研        & 自研     & OpenSBI \\ \hline
		其他架构支持     & 不支持       & 不支持    & 支持      \\ \hline
	\end{tabular}
\end{table}

除此以外，开源的实时操作系统FreeRTOS也被移植到了RISC-V架构的开源开发板K210上。

综上，目前大多数RISC-V架构的通用操作系统实现都是教学用，且完成度不一：xv6-riscv完成度较高，而BlogOS和rCore的完成度则相对较低，仅仅起到演示作用。三者都是基于RV64实现的操作系统，即RISC-V的64位宽标准。这三者都没有实现POSIX标准，导致一般的符合类unix标准的应用程序都难以移植到这些操作系统上，这使得这三个操作系统的兼容性较差，而RISC-V架构被广为质疑的问题之一就是生态问题。且在国外，除去xv6-riscv和BlogOS外，还有大量RISC-V操作系统项目遍地开花，与国内冷清的现状形成了鲜明对比。

\section{研究内容}

基于上述的现状，为了进一步推动RISC-V架构在我国高校操作系统课程中的下沉，本文尝试提出一种基于C语言的操作系统设计并给出其实现。第 \ref{chapter:riscv} 章简要介绍了RISC-V架构的硬件机制，第 \ref{chapter:overall} 章讨论了这个操作系统的整体设计，并按照模块划分，给出模块划分图。第 \ref{chapter:interrupt} 章、第 \ref{chapter:memory} 章、第 \ref{chapter:thread} 章和第 \ref{chapter:filesystem} 章分别对操作系统的主要组成部分：中断管理、内存管理、线程调度和文件系统进行细化讨论，并给出了各个模块的方案。第 \ref{chapter:shell} 章给出了一个简单的shell实现，用户可以通过这个shell与操作系统交互。最终实现一个基本功能完备的操作系统，代码规范清晰，方便横向扩展，同时文档完备，十分适合作教学使用。